<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1">
      <i class="fas fa-project-diagram me-2 text-primary"></i>My Projects
    </h2>
    <p class="text-muted">Manage and track all your projects in one place</p>
  </div>
  <button
    class="btn btn-primary btn-lg"
    data-bs-toggle="modal"
    data-bs-target="#createProjectModal"
  >
    <i class="fas fa-plus me-2"></i>New Project
  </button>
</div>

<!-- Projects Statistics -->
<div class="row mb-4">
  <div class="col-md-3 mb-3">
    <div class="card stat-card bg-primary text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h4 class="card-title mb-0"><%= projects.length %></h4>
            <p class="card-text mb-0">Total Projects</p>
          </div>
          <i class="fas fa-project-diagram fa-2x opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card stat-card bg-success text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <% const completedTasksTotal = projects.reduce((total, p) => { const
            tasks = p.tasks || []; return total + tasks.filter(t => t.status ===
            'COMPLETED').length; }, 0); %>
            <h4 class="card-title mb-0"><%= completedTasksTotal %></h4>
            <p class="card-text mb-0">Completed Tasks</p>
          </div>
          <i class="fas fa-check-circle fa-2x opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card stat-card bg-warning text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <% const inProgressTotal = projects.reduce((total, p) => { const
            tasks = p.tasks || []; return total + tasks.filter(t => t.status ===
            'IN_PROGRESS').length; }, 0); %>
            <h4 class="card-title mb-0"><%= inProgressTotal %></h4>
            <p class="card-text mb-0">In Progress</p>
          </div>
          <i class="fas fa-spinner fa-2x opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card stat-card bg-info text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <% const pendingTotal = projects.reduce((total, p) => { const tasks
            = p.tasks || []; return total + tasks.filter(t => t.status ===
            'PENDING').length; }, 0); %>
            <h4 class="card-title mb-0"><%= pendingTotal %></h4>
            <p class="card-text mb-0">Pending Tasks</p>
          </div>
          <i class="fas fa-clock fa-2x opacity-50"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Projects Grid -->
<% if (projects.length > 0) { %>
<div class="row">
  <% projects.forEach(project => { const tasks = project.tasks || []; const
  completedTasks = tasks.filter(t => t.status === 'COMPLETED').length; const
  totalTasks = tasks.length; const progress = totalTasks > 0 ?
  Math.round((completedTasks / totalTasks) * 100) : 0; const overdueTasks =
  tasks.filter(t => { if (!t.dueDate) return false; return new Date(t.dueDate) <
  new Date() && t.status !== 'COMPLETED'; }).length; %>
  <div class="col-xl-4 col-lg-6 mb-4">
    <div class="card h-100 project-card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="card-title mb-0 text-truncate"><%= project.name %></h5>
        <span class="badge bg-<%= overdueTasks > 0 ? 'danger' : 'secondary' %>">
          <%= totalTasks %> tasks
        </span>
      </div>
      <div class="card-body">
        <% if (project.description) { %>
        <p class="card-text text-muted"><%= project.description %></p>
        <% } %>

        <div class="mb-3">
          <small class="text-muted">Progress</small>
          <div class="progress" style="height: 8px">
            <div
              class="progress-bar bg-<%= progress === 100 ? 'success' : 'primary' %>"
              role="progressbar"
              <% /* eslint-disable css-propertyvalueexpected */ %> 
              style="width: <%= progress %>%"
              aria-valuenow="<%= progress %>"
              aria-valuemin="0"
              aria-valuemax="100"
            ></div>
          </div>
          <div class="d-flex justify-content-between mt-1">
            <small><%= progress %>% complete</small>
            <small><%= completedTasks %>/<%= totalTasks %> tasks</small>
          </div>
        </div>

        <div class="row text-center">
          <div class="col-4">
            <div class="border rounded p-2">
              <div class="text-primary fw-bold">
                <%= tasks.filter(t => t.status === 'PENDING').length %>
              </div>
              <small class="text-muted">Pending</small>
            </div>
          </div>
          <div class="col-4">
            <div class="border rounded p-2">
              <div class="text-warning fw-bold">
                <%= tasks.filter(t => t.status === 'IN_PROGRESS').length %>
              </div>
              <small class="text-muted">In Progress</small>
            </div>
          </div>
          <div class="col-4">
            <div class="border rounded p-2">
              <div class="text-success fw-bold"><%= completedTasks %></div>
              <small class="text-muted">Done</small>
            </div>
          </div>
        </div>
      </div>
      <div class="card-footer bg-transparent">
    <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted">
            <i class="fas fa-calendar me-1"></i>
            <%= new Date(project.startDate).toLocaleDateString() %> - <%= new Date(project.endDate).toLocaleDateString() %>
        </small>
        <div class="btn-group" role="group">
            <a href="/projects/<%= project.id %>" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-eye me-1"></i>View
            </a>
            <a href="/projects/<%= project.id %>/edit" class="btn btn-sm btn-outline-warning">
                <i class="fas fa-edit me-1"></i>Edit
            </a>
        </div>
    </div>
</div>
    </div>
  </div>
  <% }); %>
</div>
<% } else { %>
<div class="text-center py-5">
  <i class="fas fa-project-diagram fa-4x text-muted mb-3"></i>
  <h4 class="text-muted">No Projects Yet</h4>
  <p class="text-muted mb-4">Get started by creating your first project</p>
  <button
    class="btn btn-primary btn-lg"
    data-bs-toggle="modal"
    data-bs-target="#createProjectModal"
  >
    <i class="fas fa-plus me-2"></i>Create Your First Project
  </button>
</div>
<% } %>

<!-- Create Project Modal -->
<div class="modal fade" id="createProjectModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form
        action="/projects"
        method="POST"
        onsubmit="return validateProjectDates()"
      >
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-plus me-2"></i>Create New Project
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="name" class="form-label">Project Name</label>
              <input
                type="text"
                class="form-control"
                id="name"
                name="name"
                placeholder="Enter project name"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="description" class="form-label">Description</label>
              <input
                type="text"
                class="form-control"
                id="description"
                name="description"
                placeholder="Project description"
              />
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="startDate" class="form-label">Start Date</label>
              <input
                type="date"
                class="form-control"
                id="startDate"
                name="startDate"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="endDate" class="form-label">End Date</label>
              <input
                type="date"
                class="form-control"
                id="endDate"
                name="endDate"
                required
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Create Project
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function validateProjectDates() {
    const startDate = new Date(document.getElementById("startDate").value);
    const endDate = new Date(document.getElementById("endDate").value);

    if (startDate > endDate) {
      alert("End date must be after start date");
      return false;
    }

    return true;
  }

  // Set default dates in modal
  document.addEventListener("DOMContentLoaded", function () {
    const today = new Date().toISOString().split("T")[0];
    const nextWeek = new Date();
    nextWeek.setDate(nextWeek.getDate() + 7);
    const nextWeekFormatted = nextWeek.toISOString().split("T")[0];

    document.getElementById("startDate").value = today;
    document.getElementById("endDate").value = nextWeekFormatted;
  });
</script>
